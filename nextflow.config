/*
 * -------------------------------------------------
 *  PEARS Pipeline Configuration
 * -------------------------------------------------
 * Single-cell fusion detection pipeline
 *
 * Required inputs:
 *   - FASTQ files (R1 and R2)
 *   - Genome version (e.g., GRCh38+GENCODE44)
 *   - Known fusions list (CSV, e.g., from JAFFA output)
 *
 * Usage:
 *   nextflow run main.nf -profile <local|slurm>
 *
 * Override parameters via command line:
 *   nextflow run main.nf --fastq_r1 '/path/to/*_R1.fastq.gz' --out_dir './results'
 */
params {
    // ----- Input files -----
    fastq_r1           = null
    fastq_r2           = null
    known_fusions_list = null

    // ----- Read structure -----
    umi_len            = null

    // ----- Cell barcode -----
    barcode_include_list = "${projectDir}/assets/737K-august-2016.txt.gz"

    // ----- Reference genome -----
    genome_version     = "GRCh38+GENCODE44"  // See --help for available options
    star_genome_index  = null                // Optional: provide pre-built index to skip download/build
    ref_fasta          = null                // Optional: provide pre-built FASTA reference
    ref_gtf            = null                // Optional: provide pre-built GTF annotation

    // ----- Output -----
    out_dir            = "pears_output"

    // ----- Flexiplex parameters -----
    // Barcode demultiplexing (see Davidson et al. 2023)
    flexiplex_searchlen           = 20   // Search length for fusion sequence (2x actual length)
    flexiplex_demultiplex_options = ""   // Additional flexiplex options

    // ----- FUSCIA parameters -----
    // Fusion read extraction and annotation
    fuscia_mapqual     = 30      // Minimum mapping quality
    fuscia_up          = 1000    // Upstream search distance (bp) when no gene annotation
    fuscia_down        = 1000    // Downstream search distance (bp) when no gene annotation
}

/*
 * -------------------------------------------------
 *  Parameter Validation
 * -------------------------------------------------
 */

plugins {
    id 'nf-schema@2.3.0'
}

validation {
    help {
        enabled = true
        showHidden = false
    }
    parametersSchema = 'nextflow_schema.json'
    monochromeLogs = false
    failUnrecognisedParams = true
    lenientMode = false
}

/*
 * -------------------------------------------------
 *  Conda Environment
 * -------------------------------------------------
 */
conda {
    enabled = true
    createOptions = '--yes'
}
process.conda = "${projectDir}/env/pears_env.yml"


/*
 * -------------------------------------------------
 *  Process Resource Allocation
 * -------------------------------------------------
 * Assign resources using process labels:
 *   label 'process_high'   - STAR alignment, intensive tasks
 *   label 'process_medium' - Moderate memory/CPU tasks
 *   label 'process_low'    - Light processing
 *   label 'process_tiny'   - File operations, parsing
 */
process {
    withLabel: 'process_high' {
        cpus   = 16
        memory = '256 GB'
        time   = '48h'
    }
    withLabel: 'process_medium' {
        cpus   = 8
        memory = '64 GB'
        time   = '24h'
    }
    withLabel: 'process_low' {
        cpus   = 4
        memory = '16 GB'
        time   = '8h'
    }
    withLabel: 'process_tiny' {
        cpus   = 1
        memory = '4 GB'
        time   = '1h'
    }
}


/*
 * -------------------------------------------------
 *  Execution Profiles
 * -------------------------------------------------
 * Select with: -profile <name>
 *   local  - Run on local machine
 *   slurm  - Submit to SLURM cluster
 */
profiles {
    local {
        process.executor = 'local'
    }
    slurm {
        process.executor = 'slurm'
    }
}

/*
 * -------------------------------------------------
 *  Trace and Reporting
 * -------------------------------------------------
 */
trace {
    enabled = true
    file = "${params.out_dir}/nextflow_trace.txt"
    overwrite = true
}

report {
    enabled = true
    file = "${params.out_dir}/nextflow_report.html"
    overwrite = true
}

manifest.defaultBranch = "main"
